<!DOCTYPE html>
<html>
  <head>
    <title>Hello World</title>
    <link rel="shortcut icon" href="#" />
    <!--
    <script src="https://cdn.8thwall.com/web/aframe/8frame-1.2.0.min.js"></script>
    <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>
    <script src="https://apps.8thwall.com/xrweb?appKey=f0LPUhzxQRN1kc4sv4mM4ZRsl663KCFL7y7fj3Uc5wN7TNKY7TbKuJlwz5uu0zGbngfYA3"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-core@3.13.0/dist/tf-core.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-converter@3.13.0/dist/tf-converter.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl@3.13.0/dist/tf-backend-webgl.js"></script>
    <script src="https://unpkg.com/@tensorflow-models/handpose@0.0.7/dist/handpose.js"></script>
    -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://supereggbert.github.io/aframe-htmlembed-component/dist/build.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
      body {
        background-color: black;
      }
      .highlight {
        background-color: red;
      }
      .word {
        color: white;
      }
    </style>

    <script>
      /*
      AFRAME.registerComponent('test', {
        init: function() {
          console.log('test')
          XR8.addCameraPipelineModule(
            XR8.CameraPixelArray.pipelineModule(),
          )
          XR8.addCameraPipelineModule(
            customPipelineModule()
          )
        },
      })

      async function loadModel() {
        window.model = await handpose.load()
      }
      loadModel()

      async function predict(processGpuResult) {
        let width = processGpuResult.camerapixelarray.cols
        let height = processGpuResult.camerapixelarray.rows
        let pixels = processGpuResult.camerapixelarray.pixels
        let imageData = new ImageData(width, height)
        imageData.data.set(pixels)
        let predictions = await window.model.estimateHands(imageData)
        if (predictions && predictions.length > 0) {
          console.log(predictions)
        } else {
          console.log('not found')
        }
      }

      const customPipelineModule = () => {
        return {
          name: 'qrprocess',
          onProcessCpu: ({processGpuResult}) => {
            if (!processGpuResult.camerapixelarray || !processGpuResult.camerapixelarray.pixels) {
              return {found: false}
            }

            try {
              window.processGpuResult = processGpuResult
              predict(processGpuResult)
              return {}
            } catch (e) {
              return {found: false}
            }
          },
        }
      }
      */

      window.SpeechRecognition =
        window.SpeechRecognition || webkitSpeechRecognition;
      recognition = new window.SpeechRecognition();
      recognition.lang = "en-US";
      // recognition.lang = "zh-CN";
      recognition.interimResults = true;
      recognition.continuous = true;
      let textEl = document.querySelector("#text");
      let debugEl = document.querySelector("#debug");

      recognition.addEventListener('error', function(event) {
        debugEl.innerText = event.error + ' and ' + recognition
      })

      let finalTranscript = "";
      recognition.onresult = (event) => {
        let interimTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          let transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
            interimTranscript = "";
          } else {
            interimTranscript += transcript;
          }
          let text = finalTranscript + interimTranscript;
          // debugEl.innerText = value
          // textEl.setAttribute("value", value);
          text = text.replace(/(\r\n|\n|\r)/gm, ' ')
          console.log(`emitting ${text}`)
          socket.emit('message', text)

          let resultDiv = document.querySelector("#result-div");
          resultDiv.innerHTML = "";
          let html = getHTML(text);
          console.log(html)
          resultDiv.innerHTML = html;
        }
      };

      recognition.start();

      const socket = io();
      socket.on('message', (data) => {
        let json = JSON.parse(data)
        // let res = JSON.stringify(json, null, 2)
        // $("pre").text(res);
        console.log(json)
      })

      function getHTML(transcript) {
        let html = "";
        let words = transcript.split(" ");
        // let highlightWords = getHighlightWords(words, entities)
        let i = 0
        // let highlightWord = highlightWords[i]
        for (let j = 0; j < words.length; j++) {
          let word = words[j];
          let className = 'word draggable'
          // if (highlightWord && j === highlightWord.index) {
          //   className += ' '
          //   className += 'highlight'
          //   i = i + 1
          //   highlightWord = highlightWords[i]
          // }
          html +=
            `<i class="${className}" \
                id="word-${j}-${word}"\
                draggable="true" \
                ondragstart="onDragStart(event)" \
                >` +
            word +
            "</i>" +
            " ";
        }
        return html;
      }

    </script>

  </head>

  <body>

    <a-scene
      test
    >
      <a-camera position="0 0 0" rotation="-45 0 0">
        <a-cursor gaze-event material="color: white;"></a-cursor>
      </a-camera>
      <a-entity htmlembed htmlinit position="0 1 -3">
        <div id="result-div">
          <i class="word">Hello</i><i class="word">World</i>
        </div>
      </a-entity>
    </a-scene>


  </body>
</html>
