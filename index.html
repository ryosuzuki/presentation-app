<!DOCTYPE html>
<html>
  <head>
    <title>Hello World</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!--
    <script src="https://cdn.8thwall.com/web/aframe/8frame-1.2.0.min.js"></script>
    <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>
    <script src="https://apps.8thwall.com/xrweb?appKey=f0LPUhzxQRN1kc4sv4mM4ZRsl663KCFL7y7fj3Uc5wN7TNKY7TbKuJlwz5uu0zGbngfYA3"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-core@3.13.0/dist/tf-core.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-converter@3.13.0/dist/tf-converter.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl@3.13.0/dist/tf-backend-webgl.js"></script>
    <script src="https://unpkg.com/@tensorflow-models/handpose@0.0.7/dist/handpose.js"></script>
    -->

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://supereggbert.github.io/aframe-htmlembed-component/dist/build.js"></script>
    <script src="https://unpkg.com/aframe-text-plane"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/letterizejs/lib/letterize.min.js"></script>

    <style>
      body {
        background-color: black;
      }
      #result-div {
        width: 500px;
        background: #222;
      }
      .word {
        color: white;
      }
      .NN, .NNS, .NNP {
        background-color: gray;
      }
      .highlight-1 {
        background-color: orange;
      }
    </style>

    <script>
      /*
      AFRAME.registerComponent('test', {
        init: function() {
          console.log('test')
          XR8.addCameraPipelineModule(
            XR8.CameraPixelArray.pipelineModule(),
          )
          XR8.addCameraPipelineModule(
            customPipelineModule()
          )
        },
      })

      async function loadModel() {
        window.model = await handpose.load()
      }
      loadModel()

      async function predict(processGpuResult) {
        let width = processGpuResult.camerapixelarray.cols
        let height = processGpuResult.camerapixelarray.rows
        let pixels = processGpuResult.camerapixelarray.pixels
        let imageData = new ImageData(width, height)
        imageData.data.set(pixels)
        let predictions = await window.model.estimateHands(imageData)
        if (predictions && predictions.length > 0) {
          console.log(predictions)
        } else {
          console.log('not found')
        }
      }

      const customPipelineModule = () => {
        return {
          name: 'qrprocess',
          onProcessCpu: ({processGpuResult}) => {
            if (!processGpuResult.camerapixelarray || !processGpuResult.camerapixelarray.pixels) {
              return {found: false}
            }

            try {
              window.processGpuResult = processGpuResult
              predict(processGpuResult)
              return {}
            } catch (e) {
              return {found: false}
            }
          },
        }
      }
      */

      window.SpeechRecognition =
        window.SpeechRecognition || webkitSpeechRecognition;
      recognition = new window.SpeechRecognition();
      recognition.lang = "en-US";
      // recognition.lang = "zh-CN";
      recognition.interimResults = true;
      recognition.continuous = true;
      let textEl = document.querySelector("#text");
      let debugEl = document.querySelector("#debug");

      recognition.addEventListener('error', function(event) {
        console.log(event.error + ' and ' + recognition)
      })

      let finalTranscript = "";
      recognition.onresult = (event) => {
        let interimTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          let transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
            interimTranscript = "";
          } else {
            interimTranscript += transcript;
          }
          let text = finalTranscript + interimTranscript;
          // debugEl.innerText = value
          // textEl.setAttribute("value", value);
          text = text.replace(/(\r\n|\n|\r)/gm, ' ')
          console.log(`emitting ${text}`)
          socket.emit('message', text)

        }
      };

      recognition.start();

      const socket = io();
      socket.on('message', (data) => {
        let json = JSON.parse(data)
        console.log(json)
        showText(json)
        return

        let resultDiv = document.querySelector("#result-div");
        resultDiv.innerHTML = "";
        let html = getHTML(json);
        resultDiv.innerHTML = html;
        // let res = JSON.stringify(json, null, 2)
        // $("pre").text(res);
      })

      function showText(json) {
        let tokens = json.tokens
        let entities = json.entities
        let html = ""

        let keywords = {}
        for (let entity of entities) {
          keywords[entity.text] = entity.label
        }

        let sceneEl = document.querySelector('a-scene')
        let words = document.querySelector('a-entity#words')
        if (!words) {
          words = document.createElement('a-entity')
          words.setAttribute('id', 'words')
          sceneEl.appendChild(words)
        }
        let pos = { x: -3, y: 0, z: -3}
        let len = 0
        let width = 0
        for (let i = 0; i < tokens.length; i++) {
          let token = tokens[i];
          let word = token.text
          let tag = token.tag

          pos.x += width
          width = word.length/4
          pos.x += width
          let el = document.querySelector(`a-entity#word-${i}`)
          if (!el) {
            el = document.createElement('a-entity')
            el.setAttribute('id', `word-${i}`)
            words.appendChild(el)
          }
          // el.setAttribute('geometry', `primitive: plane; width: ${width}; height: 0.1`)
          // el.setAttribute('material', 'opacity: 0.2; transparent: true')
          // el.setAttribute('text', `height: 0.1; width: ${width}; anchor: center; align: center; wrap-count: ${word.length+1}; color: white; value: ${word}`)
          el.setAttribute('text-plane', `text: ${word}`)
          el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`)
          el.setAttribute('hoge', true)

          console.log(el.object3D)
          // el.object3D.onBeforeRender(sceneEl.renderer, sceneEl.object3D, cameraEl.object3D)
          // setTimeout(() => {
          //   console.log(el.object3D.children)
          //   if (el.object3D.children.length > 0) {
          //     let width = el.object3D.children[0].scale.x
          //     let height = el.object3D.children[0].scale.y
          //     console.log(width)
          //     pos.x += width
          //   }
          // }, 10)

          // console.log(el.object3D.children)
          // if (el.object3D.children.length > 0) {
          //   let width = el.object3D.children[0].scale.x
          //   let height = el.object3D.children[0].scale.y
          //   pos.x += width
          // }
        }
      }


      AFRAME.registerComponent('hoge', {
        init: function() {
          animateText({
            el: this.el,
            translateX: 2,
            scale: 2,
            rotation: 90,
            opacity: 0.2,
            color: '#0ee',
            loop: false,
          })
        },
      })

      function animateText(config) {
        let defaultConfig = {
          loop: true,
          direction: 'alternate',
          easing: 'easeInOutExpo',
        }
        config = Object.assign(defaultConfig, config)
        let el = config.el
        let pos = el.getAttribute('position')
        let scale = el.getAttribute('scale')
        let rotation = el.getAttribute('rotation')
        let text = {}
        text = el.getAttribute('text-plane') // text
        let params = {
          posX: pos.x,
          posY: pos.y,
          posZ: pos.z,
          scaleX: scale.x,
          scaleY: scale.y,
          scaleZ: scale.z,
          rotationX: rotation.x,
          rotationY: rotation.y,
          rotationZ: rotation.z,
          // color: text.color,
          // opacity: text.opacity,
          // letterSpacing: text.letterSpacing
        }
        if (config.translateX) {
          config.posX = params.posX + config.translateX
        }
        if (config.translateY) {
          config.posY = params.posY + config.translateY
        }
        if (config.translateZ) {
          config.posZ = params.posZ + config.translateZ
        }
        if (config.scale) {
          config.scaleX = config.scale
          config.scaleY = config.scale
          config.scaleZ = config.scale
        }
        if (config.rotation) {
          config.rotationZ = config.rotation
        }
        config = Object.assign(config, {
          targets: params,
          update: () => {
            el.setAttribute('position', { x: params.posX, y: params.posY, z: params.posZ })
            el.setAttribute('scale', { x: params.scaleX, y: params.scaleY, z: params.scaleZ })
            el.setAttribute('rotation', { x: params.rotationX, y: params.rotationY, z: params.rotationZ })
            // el.setAttribute('text-plane', Object.assign(text, { color: params.color, opacity: params.opacity, letterSpacing: params.letterSpacing }))
          }
        })
        anime(config)
      }
    </script>

  </head>

  <body>
    <a-scene test>
      <a-camera position="0 0 0" rotation="-45 0 0">
        <a-cursor gaze-event material="color: white;"></a-cursor>
      </a-camera>
      <a-entity htmlembed htmlinit position="0 1 -3">
        <div id="result-div">
          <i class="word">Hello</i><i class="word">World</i>
          <h1 class="word">An animated element</h1>
        </div>
      </a-entity>
      <a-entity id="hoge" hoge text-plane="text: hoge" position="0 -1 -3" class="word"></a-entity>
      <a-entity id="fuga" text="value: fuga; width: 4" position="0 0 -3" class="word"></a-entity>
    </a-scene>

  </body>
</html>
